<html>
<head>
		<title>
				Leaflet test
		</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>
	  <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>
	<!--<script src="leaflet.ajax.min.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>
<style>
#map { height: 600px;
	   width: 600px;}
/*Custom style for leaflet options*/
.mapOptions table th {border-bottom: 2px solid #000}
.mapOptions table tr:nth-child(even) {background-color:#EEE;}

#oim{visibility: hidden}
</style>

</head>
<body>
<h1>Map display</h1>
<h2 id='oim'>OPEN INDEX MAP</h1>
<div id="map"></div>
</body>
		<script>
				var map = L.map('map').fitWorld();
				//L.popup(classname='paul')

				L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
	attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
    maxZoom: 20,
}).addTo(map);

//***********************
var gdata = new Object()
//************************
//load data

function get_data(fil){
		let xhr = new  XMLHttpRequest();
		xhr.open('GET', fil, false);//synchronous loading deprecated. Oh well.
		//xhr.setRequestHeader('Content-Type', 'application/json');
		//xhr.responseType = 'json';
		xhr.onload = function() {
			//console.log(xhr.status);
			if (xhr.status !== 200) return
			//console.log(xhr.responseText)
			//L.geoJSON(xhr.response).addTo(map);
			gdata = JSON.parse(xhr.responseText);
		};
		xhr.send();
	}
get_data('Ethiopia_50K_Topo_UBC_MQR7AY.geojson')
//get_data('UBC_Ortho_Index_2020.geojson')
//get_data('Greenland.geojson')
//get_data('pop91lin.geojson')
//get_data('geojson/UBC_Ortho_Index_2019_84.geojson')
get_data('repaired/UBC_Poly.geojson')
console.log(gdata);
//var stc_lambert = new L.Proj.CRS("EPSG:3347", "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")
//proj4.defs("urn:ogc:def:crs:EPSG::3347", "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")
//define geojson
var geojson;
//Open index map visibility flag
var visflag = false;

//Creates a tabular attribute table and
//strips out null values to make it shorter
//although I'm not sure that's the most desirable

function collate(lay){
const jdict = lay.feature.properties
var out = '';
out += '<table><th>Attribute Name</th><th>Value</th>'
//console.log(out);
for (const property in jdict){
	if (jdict[property]!== null){
			out += '<tr><td>';
			out += `${property} </td><td> ${jdict[property]}`;
			out += '</td></tr>';}
	};
	//console.log(out);
return out}

//Sets popup to a reasonable size to accommodate //attribute table
customOptions  = { 'className' : 'mapOptions',
				   'maxWidth' :800,
				   'minWidth' :250}

//Check if geojson is an Open Index Map
function is_oim(lay){
	//Open index map has no real standard. However, these 3 
    //attributes are required for Geoblacklight, so. . .
	const oim_def=['available','physHold', 'digHold']
	var count=0;
	jdict = lay.properties;
	oim_def.forEach(function(prop){
		if (jdict.hasOwnProperty(prop) && jdict[prop]!== null){
		count +=1;}
     })
	if (count == 3){return true}
	else {return false}
   }

//And open index map styling
function style_oim(lay){
	//Styles any open index map layer a different colour if "available" == true
	 //return {fillColor: '#4E9C68'},//green is for "GO"
	if (is_oim(lay)==true)
       {//console.log('TRUE');
		visflag = true;
        return {fillColor: 'orange',
 		        fillOpacity: 0.4,
				color: 'orange',
				opacity: 1.0}
       }
    }


//Add data to it to the map and zoom to the features
//geoJson = L.geoJSON(gdata, {style:style_oim, crs:L.CRS.code='EPSG:3347'})
//geoJson = L.Proj.geoJson(gdata, {style:style_oim, crs:stc_lambert})
geoJson = L.geoJSON(gdata, {style:style_oim});
//console.log(L.CRS)
geoJson.bindPopup(collate, customOptions)
geoJson.addTo(map)
map.fitBounds(geoJson.getBounds());


//Open Index map text reveal
console.log(visflag);
if (visflag == true){
	document.getElementById("oim").style.visibility = "visible";}


</script>

</body>

</html>
